# CLAUDE.md - Clade: Claude Code Workflow CLI

## What Is Clade?

Clade is a Go CLI that manages git worktrees and context for AI coding sessions. Named after biological clades (branching groups sharing common ancestry) - perfect metaphor for worktree branches.

**Core insight:** Claude Code already has hooks, sessions, MCP. Clade doesn't replace these - it orchestrates worktrees and context so Claude's built-in features work better.

**Three problems it solves:**

1. **Worktree friction** - `git worktree add ../some-path -b some-branch` is verbose. You forget the syntax. Paths are manual. You end up just stashing or making messy commits instead of properly isolating work.

2. **Multi-repo coordination** - You're building a feature across 3 repos. No native way to create matching branches, unified workspace, coordinated context. You're juggling terminal tabs and losing track.

3. **Context loss** - You're deep in a session, context built up over hours. You switch tasks or go home. Tomorrow, Claude has no idea where you left off. You waste 15 minutes re-explaining what you were doing.

Clade fixes all three.

---

## Architecture Overview

```
+-----------------------------------------------------------------+
|                           CLADE                                 |
+-----------------------------------------------------------------+
|  Worktree Management          |  Context Management             |
|  -------------------------    |  ----------------------------   |
|  o exp (experiments)          |  o inject-context (for hooks)   |
|  o project (multi-repo)       |  o Generates .claude/ config    |
|  o cleanup                    |  o Tracks state                 |
|  o list / status              |                                 |
|  o resume                     |                                 |
+-----------------------------------------------------------------+
|  Agent Launcher (configurable)                                  |
|  o Default: claude                                              |
|  o Alt: cursor, code, $EDITOR                                   |
+-----------------------------------------------------------------+
                                |
                                v
+-----------------------------------------------------------------+
|                    Claude Code (or other agent)                 |
+-----------------------------------------------------------------+
|  SessionStart Hook -> calls `clade inject-context`              |
|  /drop command -> writes DROPBAG.md                             |
|  JIRA MCP -> fetches ticket (if referenced)                     |
|  Sessions -> --resume, --continue                               |
+-----------------------------------------------------------------+
```

**Key principle:** Clade manages worktrees and generates context. Claude's hooks do the injection. Claude's MCP fetches external data. Clean separation.

---

## Directory Structure

### Clade's Home: `~/clade/`

```
~/clade/                                    # Everything clade creates lives here
+-- experiments/                            # Quick experiments
|   +-- my-api-try-redis/                   # {repo}-{exp-name}
|   +-- my-api-PROJ-1234/                   # Ticket investigations
|   +-- my-frontend-new-ui-spike/
|
+-- projects/                               # Multi-repo workspaces
|   +-- api-integration/                    # Project name
|       +-- backend/                        # Worktree: my-api
|       +-- package/                        # Worktree: my-package
|       +-- admin-ui/                       # Worktree: my-frontend
|
+-- scratch/                                # No-git scratch folders
|   +-- doc-review/                         # Document analysis
|   +-- meeting-notes/                      # Temporary workspace
|
+-- state.json                              # Clade's state tracking
```

### Config: `~/.config/clade/`

```
~/.config/clade/
+-- config.json                             # User configuration
```

### Per-Worktree: `.claude/` (Generated by clade init)

```
{any-worktree}/
+-- .claude/
|   +-- settings.json                       # Hooks configuration
|   +-- commands/
|       +-- drop.md                         # /drop command
+-- .clade.json                             # Clade metadata (ticket, type, etc.)
+-- CLAUDE.md                               # Project context
+-- DROPBAG.md                              # Handoff notes (gitignored)
```

---

## Commands

### `clade init`

**Purpose:** Setup a repo for clade (generates .claude/ config with hooks)

```bash
cd ~/repos/my-api
clade init
```

**Creates:**
```
.claude/
+-- settings.json         # SessionStart hook
+-- commands/
    +-- drop.md           # /drop command

# Also appends to .gitignore:
DROPBAG.md
.clade.json
```

**settings.json:**
```json
{
  "hooks": {
    "SessionStart": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "clade inject-context"
      }]
    }]
  }
}
```

**commands/drop.md:**
```markdown
Write a DROPBAG.md file in the repo root with:

## Summary
What we accomplished this session.

## Current State
What's working, what's broken.

## Next Steps
Exact actions to continue (be specific).

## Key Files
Files to look at first when resuming.

## Open Questions
Anything unresolved.

Save the file, then confirm it's written.
```

---

### `clade repo add <path>`

**Purpose:** Register a repo for quick access from anywhere.

```bash
clade repo add ~/repos/my-api
clade repo add ~/repos/my-frontend
clade repo add ~/repos/my-package
```

**What happens:**
- Validates path is a git repo
- Adds to `~/.config/clade/config.json` repos list
- Uses directory name as short name (or specify with `--name`)

```bash
clade repo add ~/repos/my-api --name backend
# Now you can use: clade exp try-redis -r backend
```

---

### `clade repo list`

**Purpose:** Show registered repos.

```bash
$ clade repo list

Registered repos:
  my-api         ~/repos/my-api (last used)
  my-frontend    ~/repos/my-frontend
  my-package     ~/repos/my-package
```

---

### `clade repo remove <name>`

**Purpose:** Unregister a repo.

```bash
clade repo remove my-frontend
```

---

### Repo Selection Logic

When you run `clade exp` or other commands that need a repo:

```
1. Are you in a git repo?
   YES -> Use current repo (most common case)
   NO  -> Continue to step 2

2. Did you specify --repo/-r flag?
   YES -> Use that repo (by path or registered name)
   NO  -> Continue to step 3

3. Are there registered repos?
   YES -> Interactive picker (last used at top)
   NO  -> Error: "Not in a git repo. Register repos with: clade repo add <path>"
```

**Examples:**

```bash
# In a repo - just works
cd ~/repos/my-api
clade exp try-redis

# Anywhere - specify repo
clade exp try-redis -r my-api
clade exp try-redis --repo ~/repos/my-api

# Anywhere - interactive picker
$ clade exp try-redis
Select repo:
  > my-api (last used)
    my-frontend
    my-package
```

---

### `clade exp [name]`

**Purpose:** Create isolated experiment worktree, launch agent.

```bash
clade exp try-redis
clade exp PROJ-1234              # Ticket investigation
clade exp PROJ-1234-investigate  # More descriptive
```

**What happens:**
1. Creates `~/clade/experiments/{repo}-{name}/`
2. Branch: `exp/{name}`
3. Writes `.clade.json` with metadata
4. Copies `.claude/` from main repo (or generates if missing)
5. Launches agent (default: claude)
6. SessionStart hook fires -> `clade inject-context`

**Example flow:**
```bash
$ clade exp try-redis
Creating experiment: try-redis
  Repo: my-api
  Path: ~/clade/experiments/my-api-try-redis
  Branch: exp/try-redis

Launching claude...
```

---

### `clade project [name]`

**Purpose:** Create multi-repo workspace with unified branch.

```bash
clade project api-integration
```

**Interactive prompts:**
```
Project name: api-integration
Branch name: feat/PROJ-5678/api-integration

Add repos (full path, blank when done):
  Repo: ~/repos/my-api
    Folder name [my-api]: backend
  Repo: ~/repos/my-package
    Folder name [my-package]: package
  Repo: ~/repos/my-frontend
    Folder name [my-frontend]: admin-ui
  Repo:

Creating project...
  + backend
  + package
  + admin-ui

Project ready: ~/clade/projects/api-integration
Launching claude...
```

**Creates:**
```
~/clade/projects/api-integration/
+-- backend/          # Worktree from my-api
+-- package/          # Worktree from my-package
+-- admin-ui/         # Worktree from my-frontend
+-- .clade-project.json
```

---

### `clade list`

**Purpose:** Show all active worktrees, experiments, projects.

```bash
$ clade list

Experiments:
  try-redis (my-api)
    Branch: exp/try-redis
    Path: ~/clade/experiments/my-api-try-redis
    Age: 2 hours
    Status: uncommitted changes

  PROJ-1234 (my-api)
    Branch: exp/PROJ-1234
    Path: ~/clade/experiments/my-api-PROJ-1234
    Age: 3 days (stale)
    Status: clean

Projects:
  api-integration
    Branch: feat/PROJ-5678/api-integration
    Path: ~/clade/projects/api-integration
    Repos: backend, package, admin-ui
    Age: 1 day
```

---

### `clade status`

**Purpose:** Show context for current directory.

```bash
$ cd ~/clade/experiments/my-api-try-redis
$ clade status

Experiment: try-redis
  Repo: my-api
  Branch: exp/try-redis
  Type: experiment

Context Files:
  + CLAUDE.md (project context)
  + DROPBAG.md (handoff notes from yesterday)
  - TICKET.md (no ticket linked)

Git Status:
  3 files changed, 47 insertions

Recent Sessions:
  2 hours ago - "implementing redis cache layer"
  yesterday - "initial setup"
```

---

### `clade resume [name]`

**Purpose:** Find worktree, cd there, launch agent. Hook handles context injection.

```bash
clade resume                    # Interactive picker
clade resume try-redis          # Specific experiment
clade resume api-integration    # Project
```

**What happens:**
1. Finds worktree by name
2. Changes to that directory
3. Launches agent
4. SessionStart hook fires -> `clade inject-context`
5. Claude sees DROPBAG.md, git status, TODOs, ticket info

---

### `clade scratch [name]`

**Purpose:** Create a no-git scratch folder for documents or analysis.

```bash
clade scratch doc-review
clade scratch PROJ-1234          # Ticket investigation (no code)
clade scratch meeting-notes      # Temporary workspace
```

**Unlike experiments, scratch folders:**
- Have no git repository or worktree
- Are for temporary document analysis, file sharing, etc.
- Still get `.claude/` config for hooks and context

**What happens:**
1. Creates `~/clade/scratch/{name}/`
2. Writes `.clade.json` with metadata
3. Initializes `.claude/` configuration
4. Launches agent (default: claude)

**Example flow:**
```bash
$ clade scratch doc-review
Creating scratch: doc-review
  Path: ~/clade/scratch/doc-review

Initializing .claude/ configuration...
Scratch folder created!
Launching claude...
```

---

### `clade cleanup [name]`

**Purpose:** Remove worktree and optionally delete branch.

```bash
clade cleanup try-redis
```

**What happens:**
1. Checks for uncommitted changes (warns if present)
2. Checks if branch is merged (via git or gh CLI)
3. Removes worktree
4. Prompts to delete branch
5. Updates state.json

```bash
$ clade cleanup try-redis

Experiment: try-redis
  Path: ~/clade/experiments/my-api-try-redis
  Branch: exp/try-redis

!  Uncommitted changes detected:
  M src/cache.ts
  A src/redis-client.ts

Discard changes and continue? [y/N]: y

Removing worktree... done
Delete branch exp/try-redis? [y/N]: y
Deleting branch... done

Cleaned up.
```

---

### `clade inject-context`

**Purpose:** Called by SessionStart hook. Outputs context to stdout for Claude.

**Not user-facing** - the hook calls this automatically.

```bash
# Called automatically by hook, but you can test it:
$ clade inject-context

# Session Context

## DROPBAG.md (from yesterday)
We implemented the basic redis connection but haven't tested it yet.
Next step: write tests for cache invalidation.
Key file: src/cache.ts

## Git Status
On branch exp/try-redis
Changes not staged:
  modified: src/cache.ts
  new file: src/redis-client.ts

## Recent Commits
a1b2c3d - feat: add redis client wrapper
e4f5g6h - chore: initial experiment setup

## Open TODOs
src/cache.ts:42: TODO: implement cache invalidation
src/cache.ts:78: TODO: add TTL support

## Ticket
PROJ-1234 detected. Please fetch from JIRA and save to TICKET.md
```

---

## Configuration

### `~/.config/clade/config.json`

```json
{
  "base_dir": "~/clade",
  "agent": "claude",
  "agent_flags": ["--dangerously-skip-permissions"],
  "auto_init": true,
  "repos": {
    "my-api": "~/repos/my-api",
    "my-frontend": "~/repos/my-frontend",
    "my-package": "~/repos/my-package"
  },
  "last_repo": "my-api"
}
```

| Field | Default | Description |
|-------|---------|-------------|
| `base_dir` | `~/clade` | Where experiments/projects are stored |
| `agent` | `claude` | Command to launch (`claude`, `cursor .`, `code .`) |
| `agent_flags` | `[]` | Flags to pass to agent |
| `auto_init` | `true` | Auto-run `clade init` on new worktrees |
| `repos` | `{}` | Registered repos (name -> path mapping) |
| `last_repo` | `null` | Last used repo (for picker default) |

---

### `~/clade/state.json`

```json
{
  "version": 1,
  "experiments": {
    "my-api-try-redis": {
      "name": "try-redis",
      "repo": "~/repos/my-api",
      "path": "~/clade/experiments/my-api-try-redis",
      "branch": "exp/try-redis",
      "ticket": null,
      "created": "2025-01-06T10:00:00Z",
      "last_used": "2025-01-06T14:30:00Z"
    },
    "my-api-PROJ-1234": {
      "name": "PROJ-1234",
      "repo": "~/repos/my-api",
      "path": "~/clade/experiments/my-api-PROJ-1234",
      "branch": "exp/PROJ-1234",
      "ticket": "PROJ-1234",
      "created": "2025-01-03T09:00:00Z",
      "last_used": "2025-01-03T17:00:00Z"
    }
  },
  "projects": {
    "api-integration": {
      "name": "api-integration",
      "path": "~/clade/projects/api-integration",
      "branch": "feat/PROJ-5678/api-integration",
      "repos": [
        {"name": "backend", "source": "~/repos/my-api"},
        {"name": "package", "source": "~/repos/my-package"},
        {"name": "admin-ui", "source": "~/repos/my-frontend"}
      ],
      "created": "2025-01-05T11:00:00Z",
      "last_used": "2025-01-06T16:00:00Z"
    }
  }
}
```

---

### `.clade.json` (Per-Worktree)

```json
{
  "type": "experiment",
  "name": "PROJ-1234",
  "ticket": "PROJ-1234",
  "repo": "my-api",
  "created": "2025-01-03T09:00:00Z"
}
```

Used by `inject-context` to know what context to generate.

---

## End-to-End Workflow

### Scenario 1: Quick Experiment

```bash
# You're in your main repo, want to try something
$ cd ~/repos/my-api
$ clade exp try-redis

Creating experiment: try-redis
  Path: ~/clade/experiments/my-api-try-redis
  Branch: exp/try-redis
Launching claude...

# Claude starts, SessionStart hook fires, you see:
# "Session context loaded from clade"

# You work for a few hours...
# Before stopping:

> /drop

# Claude writes DROPBAG.md with your current state
# You exit claude, go home

# Next morning:
$ clade resume try-redis

Resuming: try-redis
  Path: ~/clade/experiments/my-api-try-redis
Launching claude...

# SessionStart hook fires, Claude sees:
# - Your DROPBAG.md from yesterday
# - Git status showing your changes
# - Any TODOs in code
# You're immediately back in context

# Experiment worked! Clean up:
$ clade cleanup try-redis --merge

# Or it failed:
$ clade cleanup try-redis  # Just deletes everything
```

---

### Scenario 2: Ticket Investigation

```bash
$ clade exp PROJ-1234

Creating experiment: PROJ-1234
  Path: ~/clade/experiments/my-api-PROJ-1234
  Branch: exp/PROJ-1234
  Ticket: PROJ-1234 (will prompt Claude to fetch)
Launching claude...

# Claude starts, sees in context:
# "Ticket PROJ-1234 detected. Please fetch from JIRA and save to TICKET.md"

# Claude uses JIRA MCP to fetch ticket, saves it
# Now you have full ticket context

# Investigate, fix, done:
$ clade cleanup PROJ-1234
```

---

### Scenario 3: Multi-Repo Feature

```bash
$ clade project api-integration

Project name: api-integration
Branch: feat/PROJ-5678/api-integration

Add repos:
  ~/repos/my-api -> backend
  ~/repos/my-package -> package
  ~/repos/my-frontend -> admin-ui

Creating project...
Launching claude...

# Claude sees all three repos in ~/clade/projects/api-integration/
# You work across backend/, package/, admin-ui/

# End of day:
> /drop

# Next day:
$ clade resume api-integration

# All context restored, all three repos ready
```

---

### Scenario 4: See What's Active

```bash
$ clade list

Experiments:
  try-redis (my-api) - 2 hours ago
  PROJ-1234 (my-api) - 3 days ago (stale)

Projects:
  api-integration - 1 day ago

# Oh right, I forgot about that old investigation
$ clade cleanup PROJ-1234
```

---

## Project Structure (Go)

```
clade/
+-- cmd/
|   +-- clade/
|       +-- main.go                 # Entry point, cobra setup
+-- internal/
|   +-- cmd/                        # Command implementations
|   |   +-- init.go                 # clade init
|   |   +-- exp.go                  # clade exp
|   |   +-- repo.go                 # clade repo add/list/remove
|   |   +-- project.go              # clade project
|   |   +-- list.go                 # clade list
|   |   +-- status.go               # clade status
|   |   +-- resume.go               # clade resume
|   |   +-- cleanup.go              # clade cleanup
|   |   +-- inject.go               # clade inject-context
|   +-- git/                        # Git operations
|   |   +-- worktree.go
|   |   +-- branch.go
|   |   +-- status.go
|   +-- context/                    # Context generation
|   |   +-- dropbag.go              # Read DROPBAG.md
|   |   +-- todos.go                # Find TODOs in code
|   |   +-- format.go               # Format context output
|   +-- config/                     # Configuration
|   |   +-- config.go               # User config
|   |   +-- state.go                # State management
|   +-- agent/                      # Agent launching
|   |   +-- agent.go                # Interface
|   |   +-- claude.go               # Claude-specific
|   |   +-- generic.go              # Generic (cursor, code, etc.)
|   +-- ui/                         # Terminal UI
|       +-- prompt.go               # Interactive prompts
|       +-- colors.go               # Output formatting
|       +-- spinner.go              # Progress indicators
+-- templates/                      # Generated file templates
|   +-- settings.json.tmpl          # .claude/settings.json
|   +-- drop.md.tmpl                # .claude/commands/drop.md
|   +-- gitignore.tmpl              # Lines to add to .gitignore
+-- go.mod
+-- go.sum
+-- Makefile
+-- README.md
+-- CLAUDE.md                       # This file
```

---

## Dependencies

```go
// go.mod
module github.com/yourusername/clade

go 1.22

require (
    github.com/spf13/cobra v1.8.0           // CLI framework
    github.com/fatih/color v1.16.0          // Terminal colors
    github.com/manifoldco/promptui v0.9.0   // Interactive prompts
)
```

Keep it minimal. No heavy frameworks.

---

## Implementation Priority

### v0.1 (MVP)
1. `clade exp` - Most valuable, daily use
2. `clade repo add/list/remove` - Register repos for use from anywhere
3. `clade list` - See what's active
4. `clade cleanup` - Remove experiments
5. `clade inject-context` - Makes hooks work
6. `clade init` - Generate .claude/ config

### v0.2
7. `clade resume` - Smart navigation
8. `clade status` - Current context
9. `clade project` - Multi-repo workspaces

### v0.3
10. Ticket detection (JIRA pattern matching)
11. Stale experiment warnings
12. Session tracking (read ~/.claude/projects/)

---

## Claude Code Integration Points

| Feature | How Clade Uses It |
|---------|-------------------|
| **SessionStart hook** | Calls `clade inject-context` |
| **Custom commands** | `/drop` -> DROPBAG.md |
| **MCP (JIRA)** | Claude fetches ticket, not clade |
| **Sessions** | Clade tracks but Claude manages |
| **--add-dir** | For multi-repo projects |

---

## Agent-Agnostic Design

```go
// internal/agent/agent.go
type Agent interface {
    Launch(workdir string, opts LaunchOptions) error
    Name() string
}

type LaunchOptions struct {
    AddDirs []string  // Additional directories
    Flags   []string  // Extra flags
}

// internal/agent/claude.go
type ClaudeAgent struct{}

func (c *ClaudeAgent) Launch(workdir string, opts LaunchOptions) error {
    args := []string{}
    for _, dir := range opts.AddDirs {
        args = append(args, "--add-dir", dir)
    }
    args = append(args, opts.Flags...)

    cmd := exec.Command("claude", args...)
    cmd.Dir = workdir
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr
    return cmd.Run()
}

// internal/agent/generic.go
type GenericAgent struct {
    Command string  // "cursor .", "code .", etc.
}

func (g *GenericAgent) Launch(workdir string, opts LaunchOptions) error {
    parts := strings.Fields(g.Command)
    cmd := exec.Command(parts[0], parts[1:]...)
    cmd.Dir = workdir
    return cmd.Run()
}
```

Claude users get hooks + context injection. Other agents just get worktree management.

---

## Success Criteria

1. **`clade exp` takes <2 seconds** to create worktree and launch
2. **Context injection works** - SessionStart hook fires, Claude sees DROPBAG.md
3. **`clade list` is scannable** - Not walls of text
4. **Cleanup handles edge cases** - Uncommitted changes, merged branches
5. **Works on macOS and Linux**
6. **Zero config to start** - Just works with defaults

---

## Non-Goals

- GUI or TUI (CLI only)
- MCP connections (let Claude handle it)
- Billing/usage tracking
- Replacing Claude Code
- IDE integrations
- Windows support (v1)

---

## Get Started

```bash
mkdir clade && cd clade
git init

# Save this file as CLAUDE.md
# Then:
go mod init github.com/yourusername/clade
go get github.com/spf13/cobra github.com/fatih/color github.com/manifoldco/promptui

mkdir -p cmd/clade internal/{cmd,git,context,config,agent,ui} templates

claude "Read CLAUDE.md and implement clade exp first - that's the MVP"
```

---

## Quick Reference

```bash
# Repo management
clade repo add ~/repos/my-repo    # Register a repo
clade repo list                   # Show registered repos
clade repo remove my-repo         # Unregister

# Daily workflow
clade init                        # Setup .claude/ with hooks
clade exp try-something           # Quick experiment (in current repo)
clade exp try-redis -r my-repo    # Experiment in specific repo
clade exp PROJ-1234               # Ticket investigation
clade scratch doc-review          # No-git scratch folder
clade project my-feature          # Multi-repo workspace
clade list                        # What's active
clade status                      # Current context
clade resume try-something        # Get back to work
clade cleanup try-something       # Clean up when done
```
